<?xml version="1.0" encoding="UTF-8"?>
<workflow_instructions>
  <mode_overview>
    Your primary goal is to create a comprehensive feature design document based on user requirements and existing project code. You will use the embedded design template as the structure for your output.
  </mode_overview>

  <design_template>
    <![CDATA[
# [特性名称] 设计文档

## 1. 背景

### 1.1 功能简介

（简要介绍该特性是什么，解决了什么问题。）

### 1.2 需求与痛点

（详细阐述为什么需要开发该特性。可以包括当前系统存在的痛点、业务发展的需求、性能优化的需要等。）

### 1.3 使用场景

（描述该特性的具体应用场景，帮助理解其价值和使用方式。）

## 2. 概要设计

（简要描述特性的整体实现思路。用 Mermaid 图展示模块/组件之间的调用关系和数据流向。）

```mermaid
flowchart TD
    A[模块A] --> B[模块B]
    A --> C[模块C]
    B --> D[模块D]
    C --> D
```

### 2.1 模块划分

（介绍该特性实现涉及的主要模块，以及各个模块的职责。）

*   **模块A**：负责...
*   **模块B**：负责...
*   **模块C**：负责...

### 2.2 核心流程

（简洁精确地描述运行时的核心流程，用 Mermaid 图可视化主要执行路径或关键交互。）

```mermaid
flowchart LR
    A[步骤1] --> B[步骤2]
    B --> C[步骤3]
    C --> D[步骤4]
```

### 2.3 目录结构

（展示新增或修改文件的目录布局，使用树形格式。仅在特性涉及多个新文件或显著重构时包含此节。）

```
src/main/java/com/example/
├── service/
│   └── NewService.java         # (NEW) 服务描述
├── repository/
│   └── NewRepository.java      # (NEW) 仓储描述
└── controller/
    └── ExistingController.java # (MODIFIED) 变更内容
```

## 3. 数据模型/类图/API设计

（可选。如果特性不涉及新的数据结构或 API 变更，可省略本节。）

### 3.1 数据结构

（介绍该特性涉及到的核心数据结构、存储模型或文件格式。）

```mermaid
classDiagram
    class DataModel {
        +String field1
        +int field2
        +void method1()
    }
```

### 3.2 API 设计

（列出该特性对外暴露的接口或对内提供的核心方法定义。）

```java
public interface FeatureAPI {
    void newApiMethod(String param1, int param2);
}
```

## 4. 详细设计

（详细描述每个模块或流程的具体实现细节。对每个流程或模块，必须：
1. 先展示带编号步骤的 Mermaid 图（如 "1. 步骤名", "2. 步骤名"）
2. 然后在图下方提供对应编号的说明列表
3. 列表编号必须与图中步骤编号对应）

### 4.1 流程/模块一：[名称]

```mermaid
sequenceDiagram
    autonumber
    participant Client
    participant Server
    participant Database
    Client->>Server: 1. 发送请求
    Server->>Server: 2. 校验请求
    Server->>Database: 3. 查询数据
    Database-->>Server: 4. 返回数据
    Server-->>Client: 5. 发送响应
```

**流程说明：**

1. **发送请求**：客户端发起请求，携带必要参数。
2. **校验请求**：服务端校验请求参数和认证信息。
3. **查询数据**：服务端向数据库查询所需信息。
4. **返回数据**：数据库返回查询结果。
5. **发送响应**：服务端处理数据后返回给客户端。

### 4.2 流程/模块二：[名称]

```mermaid
flowchart TD
    A["1. 开始处理"] --> B["2. 初始化"]
    B --> C{"3. 检查条件"}
    C -->|是| D["4. 分支A处理"]
    C -->|否| E["5. 分支B处理"]
    D --> F["6. 完成"]
    E --> F
```

**流程说明：**

1. **开始处理**：流程入口。
2. **初始化**：设置必要的变量和配置。
3. **检查条件**：评估业务逻辑条件。
4. **分支A处理**：条件为真时执行。
5. **分支B处理**：条件为假时执行。
6. **完成**：完成处理并清理资源。

## 5. 实现变更

(用代码框架标明修改位置，用自然语言描述具体变更。按流程/模块组织，每个文件独立代码块。聚焦于"改什么"，保持简洁高密度。)

**标记约定：**
- `// NEW: <文件路径>` - 新增文件或类
- `// MODIFIED: <文件路径>` - 修改现有文件
- `// ...existing...` - 省略未改动部分
- `// @before: <代码>` / `// @after: <代码>` - 标明方法内的位置
- `// + <描述>` - 新增逻辑
- `// ~ <描述>` - 修改现有逻辑（可用 `旧 → 新` 格式）
- `// - <描述>` - 删除逻辑

### 5.1 [流程/模块名称]
> 本部分变更的简要概述。

```
// NEW: src/services/UserService.ts
class UserService {
    validateQuota(userId) {
        // 从 quotaStore 查询用户配额
        // 与限额比较，超限则抛出 QuotaExceededError
        // 返回剩余配额供客户端展示
    }
}
```

```
// MODIFIED: src/processors/OrderProcessor.ts
class OrderProcessor {
    submit(order) {
        // ...existing validation...
        // @after: validation
        // ~ queue.push(order) → queue.pushAsync(order)
        // + order.status = PENDING
        // + emit('order:submitted', order)
    }

    // - processSync(order) - 整个方法移除，替换为异步流程
}
```

## 6. 实施计划

（将设计拆分为可执行的步骤/阶段。考虑：
- 简单特性：直接列出任务，不分阶段
- 大型特性：分阶段，Phase 1 为基础/前置条件
- 仅在存在依赖时标注依赖关系
- 按重要性标注优先级：P0=必须有, P1=应该有, P2=锦上添花）

<!-- 以下两个示例仅供选择格式参考。实际文档中不要输出 "简单特性格式" / "大型特性格式" 这样的标题。根据特性复杂度选择合适的格式。 -->

### 简单特性格式：
| 任务 | 优先级 | 描述 |
|------|--------|------|
| 1. [任务名] | P0 | [简要描述] |
| 2. [任务名] | P0 | [简要描述] |
| 3. [任务名] | P1 | [简要描述] |

### 大型特性格式：

#### 阶段一：基础
> 目标：[阶段目标]

| 任务 | 优先级 | 描述 |
|------|--------|------|
| 1.1 [任务名] | P0 | [简要描述] |

#### 阶段二：核心功能
> 依赖：阶段一

| 任务 | 优先级 | 描述 |
|------|--------|------|
| 2.1 [任务名] | P0 | [简要描述] |
    ]]>
  </design_template>

  <initialization_steps>
    <step number="1">
      <action>Understand the User's Request and Design Template</action>
      <details>
        Parse the user's input to identify the core feature to be designed, its requirements, and any mentioned code files.
        Simultaneously, thoroughly review the embedded `<design_template>` which provides the required structure for the final document.
      </details>
    </step>
  </initialization_steps>

  <main_workflow>
    <phase name="Context Gathering">
      <description>Gather all necessary context from the existing codebase to inform the design.</description>
      <steps>
        <step>Use `list_files` to explore the project structure if needed.</step>
        <step>Use `read_file` to examine the contents of relevant files mentioned by the user or identified during exploration.</step>
        <step>Analyze the code to understand existing patterns, data structures, and APIs.</step>
      </steps>
    </phase>

    <phase name="Document Drafting">
      <description>Draft the feature design document section by section, following the structure from the `<design_template>`.</description>
      <steps>
        <step>
          <title>1. 背景</title>
          <content>Fill in the '功能简介', '需求与痛点', and '使用场景' sections based on the user's request.</content>
        </step>
        <step>
          <title>2. 概要设计 (High-Level Design)</title>
          <content>Describe the overall approach. Create a Mermaid diagram showing module call relationships and data flow. Use a separate Mermaid diagram in '核心流程' to show the runtime execution path.</content>
        </step>
        <step>
          <title>3. 数据模型/API设计 (Data Model/API Design)</title>
          <content>Optional. Define the core data structures using a Mermaid class diagram. List the new public APIs or core internal methods. Omit if not applicable.</content>
        </step>
        <step>
          <title>4. 详细设计 (Detailed Design)</title>
          <content>For each major module or flow, provide a detailed explanation. Use Mermaid sequence diagrams to illustrate interactions between components.</content>
        </step>
        <step>
          <title>5. 实现变更 (Implementation Changes)</title>
          <content>Use code skeleton to show WHERE to change, use natural language to describe WHAT to change. Organize by process/module. Keep it concise and high-density.</content>
        </step>
        <step>
          <title>6. 实施计划 (Implementation Plan)</title>
          <content>Break down into actionable steps with priorities. Choose flat list or phased format based on complexity.</content>
        </step>
      </steps>
    </phase>

    <phase name="Finalization">
      <description>Generate the final design document.</description>
      <steps>
        <step>Combine all the drafted sections into a single markdown file.</step>
        <step>Use `write_to_file` to save the complete design document to the project's existing `docs/` or `doc/` directory. If neither exists, default to `docs/`.</step>
      </steps>
    </phase>
  </main_workflow>

  <completion_criteria>
    <criterion>A complete design document following the template has been created and saved to a file.</criterion>
    <criterion>All sections of the design document are filled with relevant information based on the user's request and code analysis.</criterion>
    <criterion>All Mermaid diagrams are syntactically correct and relevant to the design.</criterion>
  </completion_criteria>
</workflow_instructions>
